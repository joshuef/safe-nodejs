env:
  global:
    - RUST_BACKTRACE=1
    - PATH=$PATH:$HOME/.cargo/bin
    - YARN_GPG=no # otherwise this starts gpg-agent that never exits
os:
  - osx
  - linux
  - windows

language: node_js

node_js:
  - 12
  - 10

cache: cargo

before_install:
  - |
    if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then wget -qO- "https://github.com/crazy-max/travis-wait-enhanced/releases/download/v0.2.0/travis-wait-enhanced_0.2.0_linux_x86_64.tar.gz" | tar -zxvf - travis-wait-enhanced
    mv travis-wait-enhanced /home/travis/bin/
    travis-wait-enhanced --version; fi;
  - |
    if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then wget -qO- "https://github.com/crazy-max/travis-wait-enhanced/releases/download/v0.2.0/travis-wait-enhanced_0.2.0_darwin_x86_64.tar.gz" | tar -zxvf - travis-wait-enhanced
    ll /Users/travis
    mkdirp /Users/travis/bin
    mv travis-wait-enhanced /Users/travis/bin/
    export PATH="/Users/travis/bin:${PATH}"
    travis-wait-enhanced --version; fi;
  - |
    if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then curl -LfsS -o /tmp/travis-wait-enhanced.zip "https://github.com/crazy-max/travis-wait-enhanced/releases/download/v0.2.0/travis-wait-enhanced_0.2.0_windows_x86_64.zip"
    7z x /tmp/travis-wait-enhanced.zip -y -o/usr/bin/ travis-wait-enhanced.exe -r
    travis-wait-enhanced --version; fi;
  - |
    if [[ "$TRAVIS_OS_NAME" != "windows" ]]; then
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs > rustup.rs
    chmod +x ./rustup.rs
    ./rustup.rs -y
    yarn global add neon-cli
    fi;
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then PowerShell -Command 'Set-ExecutionPolicy -ExecutionPolicy RemoteSigned'; fi;
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then PowerShell -File scripts\\install_rustup.ps1; fi;
  # - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then export PATH=$PATH:~/.cargo/bin ; fi;
  - rustup -V
  - rustc -V


  # Install NPM packages
  - node -v
  - npm -v
  - echo $TRAVIS_NODE_VERSION
  - travis-wait-enhanced --timeout 120m yarn
  - if [[ "$TRAVIS_OS_NAME" == "windows" ]]; then yarn cross-env npm_config_target=6.0.7 npm_config_arch=x64 npm_config_disturl=https://electronjs.org/headers npm_config_runtime=electron neon build --release; fi;
  # First build for electron 6 to get that ABI. Other header rebuilds work fine from there.
  - if [[ ${TRAVIS_TAG} != "" ]]; then yarn neon-build-electron; fi;


script:
  - yarn test
  # remove native folder to prevent packaging EVERYTHING
  - rm -rf native/target
  # Publish when built on a tag
  - if [[ ${TRAVIS_TAG} != "" ]]; then NODE_PRE_GYP_GITHUB_TOKEN=$GITHUB_ACCESS_TOKEN yarn upload-binaries || exit 0; fi;
